name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -euo pipefail

            echo "=== Host info ==="
            hostname
            date -u

            echo ""
            echo "=== ceefaxweb systemd unit (as running) ==="
            systemctl show ceefaxweb -p ExecStart -p WorkingDirectory -p FragmentPath
            echo ""
            systemctl status ceefaxweb --no-pager || true

            echo ""
            echo "=== Locate repo directory ==="
            # Support older server layouts that still use ceefax_station_website.
            REPO_DIR="/root/ceefax_station"
            if [ -d "/root/ceefax_station_website/.git" ] && [ ! -d "/root/ceefax_station/.git" ]; then
              REPO_DIR="/root/ceefax_station_website"
            fi
            echo "Using REPO_DIR=${REPO_DIR}"

            echo ""
            echo "=== Repo status (${REPO_DIR}) BEFORE update ==="
            cd "${REPO_DIR}"
            git remote -v
            git rev-parse --short HEAD || true
            git log -1 --oneline || true

            echo ""
            echo "=== Update repo to origin/main ==="
            # Ensure origin points to the renamed repo
            git remote set-url origin https://github.com/thaum-labs/ceefax_station.git
            git fetch origin
            git reset --hard origin/main
            git rev-parse --short HEAD
            git log -1 --oneline

            echo ""
            echo "=== Replace SM6OPW with TEST1 (one-time) ==="
            cd "${REPO_DIR}"
            if python3 -c "import sys; sys.path.insert(0, '.'); from ceefaxweb.db import connect, default_db_path; from pathlib import Path; conn = connect(default_db_path(Path('.'))); row = conn.execute('SELECT * FROM stations WHERE callsign = ?', ('SM6OPW',)).fetchone(); conn.close(); sys.exit(0 if row else 1)" 2>/dev/null; then
              echo "Found SM6OPW, replacing with TEST1..."
              echo "yes" | python3 -m ceefaxweb.scripts.replace_callsign SM6OPW TEST1 || echo "Replacement completed or failed (check output above)"
            else
              echo "SM6OPW not found, skipping replacement"
            fi

            echo ""
            echo "=== Restart ceefaxweb ==="
            systemctl restart ceefaxweb
            sleep 2
            systemctl status ceefaxweb --no-pager || true

            echo ""
            echo "=== Local health checks (localhost) ==="
            # These should return 200 when the new routes are live.
            curl -sS -i http://127.0.0.1:8088/api/version || true
            echo ""
            curl -sS -i http://127.0.0.1:8088/changelog || true
            echo ""
            curl -sS -i http://127.0.0.1:8088/api/changelog || true

