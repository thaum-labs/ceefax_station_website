<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Ceefaxstation</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html, body { height: 100%; margin: 0; padding: 0; background: #0b0b0b; }
      #app { display: grid; grid-template-columns: 1fr 414px; height: 100%; }
      #map { height: 100%; }
      #side { border-left: 1px solid #222; padding: 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #0b0b0b; color: #f3f3f3; overflow: auto; display: flex; flex-direction: column; }
      .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
      .row label { min-width: 90px; }
      select, button, input { padding: 6px 8px; }
      .muted { opacity: 0.75; font-size: 12px; }
      .box { border: 1px solid #333; padding: 8px; border-radius: 6px; margin-top: 10px; background: #111; }
      .tag { display: inline-block; padding: 2px 6px; border: 1px solid #444; border-radius: 999px; margin: 2px 4px 2px 0; font-size: 12px; }
      a { color: #ffd34d; }

      /* Sidebar logo (matches page 000 text-art) */
      .logo-wrap {
        display: flex;
        justify-content: center;
        margin: 0 0 8px 0;
      }
      .logo {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        white-space: pre;
        line-height: 1.05;
        color: #ffd34d;
        margin: 0;
        padding: 6px 8px;
        border: 1px solid #2a2a2a;
        border-radius: 6px;
        background: #0f0f0f;
        width: fit-content;
      }

      /* Simple legend (matches current map styling) */
      .legend { display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; }
      .legend-item { display: flex; align-items: center; justify-content: space-between; border: 1px solid #2a2a2a; border-radius: 6px; padding: 6px 8px; background: #0f0f0f; }
      .swatch { width: 46px; height: 18px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.25); }
      .sw-yellow { background: rgba(255,211,77,0.85); }
      .sw-blue { background: rgba(74,163,255,0.75); }
      .sw-green { background: rgba(46,204,113,0.80); }

      /* Improve click affordance on map paths */
      .leaflet-interactive { cursor: pointer; }
      
      /* Mobile touch improvements */
      #map {
        touch-action: pan-x pan-y pinch-zoom;
        -webkit-touch-callout: none;
      }

      /* Link detail table */
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #2a2a2a; padding: 6px 6px; font-size: 13px; }
      th { text-align: left; font-size: 12px; opacity: 0.85; }
      .cell-center { text-align: center; }
      .boxmark {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 3px;
        border: 1px solid rgba(255,255,255,0.35);
        font-weight: 800;
        font-size: 12px;
        line-height: 18px;
        user-select: none;
      }
      .box-ok { background: rgba(255,211,77,0.22); color: #ffd34d; border-color: rgba(255,211,77,0.55); }
      .box-bad { background: rgba(74,163,255,0.18); color: #4aa3ff; border-color: rgba(74,163,255,0.55); }

      .footer {
        margin-top: auto;
        padding-top: 12px;
        font-size: 12px;
        opacity: 0.85;
      }
      .footer .line { margin-top: 4px; }

      /* Alpha/Development notice */
      .alpha-banner {
        background: linear-gradient(135deg, rgba(255, 100, 0, 0.2), rgba(255, 150, 0, 0.15));
        border: 2px solid rgba(255, 150, 0, 0.6);
        border-radius: 6px;
        padding: 10px 12px;
        margin: 0 0 12px 0;
        text-align: center;
        font-size: 13px;
        font-weight: 600;
        color: #ffaa44;
        box-shadow: 0 0 12px rgba(255, 150, 0, 0.2);
      }
      .alpha-banner .alpha-label {
        display: inline-block;
        background: rgba(255, 150, 0, 0.25);
        padding: 2px 8px;
        border-radius: 4px;
        margin-right: 6px;
        font-size: 11px;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      /* Mobile collapsible sidebar */
      .sidebar-toggle {
        display: none;
      }
      /* Mobile-only UI elements should be hidden on desktop by default */
      .mobile-link-notification { display: none; }
      .mobile-side-header { display: none; }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        :root {
          --tab-h: calc(70px + env(safe-area-inset-bottom));
        }
        html, body {
          background: #0b0b0b;
          overflow-x: hidden;
        }
        #app {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr;
          height: 100vh;
          position: relative;
          background: #0b0b0b;
        }
        #map {
          /* Prefer stable/dynamic viewport units on mobile browsers (esp. iOS Safari URL bar) */
          height: 100vh;
          height: 100svh;
          height: 100dvh;
          width: 100%;
          background: #0b0b0b;
        }
        #side {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          /* Content-sized bottom sheet (avoid lots of blank space on phones) */
          height: auto;
          /* Fallback for browsers without svh/dvh */
          max-height: calc(100vh - env(safe-area-inset-top));
          max-height: calc(100svh - env(safe-area-inset-top));
          max-height: calc(100dvh - env(safe-area-inset-top));
          transform: translateY(calc(100% - var(--tab-h)));
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          border-left: none;
          border-top: none;
          padding: calc(6px + env(safe-area-inset-top)) calc(8px + env(safe-area-inset-right)) 0 calc(8px + env(safe-area-inset-left));
          padding-bottom: var(--tab-h);
          overflow-y: hidden;
          overflow-x: hidden;
          z-index: 1000;
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
          border-radius: 20px 20px 0 0;
          box-sizing: border-box;
        }
        #side.expanded {
          transform: translateY(0);
          /* Expanded panel should not require scrolling on mobile */
          overflow-y: hidden;
          /* Bottom tab is hidden when expanded, so don't reserve its height */
          padding-bottom: env(safe-area-inset-bottom);
        }
        /* Hide the bottom tab when expanded (it was covering content) */
        #side.expanded ~ .sidebar-toggle {
          display: none;
        }

        .mobile-side-header {
          display: none;
        }
        #side.expanded .mobile-side-header {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: flex-start;
          gap: 10px;
          padding: 6px 0 8px 0;
          margin-bottom: 6px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
        .mobile-side-handle {
          width: 44px;
          height: 5px;
          background: #555;
          border-radius: 3px;
          flex: 0 0 auto;
        }
        .mobile-side-close {
          width: 100%;
          max-width: 520px;
          appearance: none;
          border: 1px solid rgba(255, 211, 77, 0.35);
          background: rgba(255, 211, 77, 0.10);
          color: #ffd34d;
          border-radius: 999px;
          padding: 6px 10px;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          text-align: center;
        }
        .mobile-link-notification {
          display: none;
          position: fixed;
          top: calc(env(safe-area-inset-top) + 10px);
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 211, 77, 0.95);
          color: #0b0b0b;
          padding: 10px 16px;
          border-radius: 8px;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
          font-size: 13px;
          font-weight: 600;
          z-index: 2000;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          max-width: calc(100% - 32px);
          text-align: center;
          animation: slideDown 0.3s ease-out;
        }
        .mobile-link-notification.show {
          display: block;
        }
        @keyframes slideDown {
          from {
            opacity: 0;
            transform: translateX(-50%) translateY(-10px);
          }
          to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
          }
        }
        .sidebar-toggle {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          height: var(--tab-h);
          background: #0b0b0b;
          border: none;
          border-top: 2px solid #333;
          border-radius: 20px 20px 0 0;
          z-index: 1001;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          user-select: none;
          -webkit-tap-highlight-color: transparent;
          padding: 0 0 env(safe-area-inset-bottom) 0;
          box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
          box-sizing: border-box;
        }
        .sidebar-toggle:hover {
          background: #111;
        }
        .sidebar-toggle::before {
          content: '';
          position: absolute;
          top: 8px;
          width: 50px;
          height: 5px;
          background: #555;
          border-radius: 3px;
          transition: all 0.3s ease;
        }
        .sidebar-toggle::after {
          content: '▲';
          position: absolute;
          top: 20px;
          color: #ffd34d;
          font-size: 16px;
          transition: transform 0.3s ease;
          transform: rotate(0deg);
        }
        #side.expanded ~ .sidebar-toggle::after {
          transform: rotate(180deg);
        }
        #side.expanded ~ .sidebar-toggle::before {
          background: #666;
        }
        .sidebar-toggle-text {
          width: 100%;
          max-width: 520px;
          appearance: none;
          border: 1px solid rgba(255, 211, 77, 0.35);
          background: rgba(255, 211, 77, 0.10);
          color: #ffd34d;
          border-radius: 999px;
          padding: 6px 10px;
          font-size: 12px;
          font-weight: 600;
          pointer-events: none;
          margin-top: 28px;
          transition: opacity 0.2s ease;
          display: inline-block;
          text-align: center;
          box-sizing: border-box;
        }
        #side.expanded ~ .sidebar-toggle .sidebar-toggle-text {
          opacity: 0.8;
        }
        .side-inner {
          width: 100%;
          max-width: 520px;
          margin: 0 auto;
        }

        .logo-wrap {
          display: none;
        }
        .alpha-banner {
          display: none;
        }
        .row {
          flex-wrap: nowrap;
          margin-bottom: 6px;
          gap: 6px;
        }
        .row label {
          min-width: 75px;
          font-size: 13px;
          margin-bottom: 0;
        }
        select, button {
          flex: 1;
          min-width: 0;
          padding: 6px 8px;
          font-size: 13px;
        }
        #status {
          font-size: 11px;
          margin: 4px 0;
        }
        .box {
          padding: 6px 8px;
          margin-top: 6px;
          font-size: 12px;
        }
        .box strong {
          font-size: 12px;
        }
        .legend {
          gap: 4px;
          margin-top: 4px;
        }
        .legend-item {
          padding: 4px 6px;
          font-size: 11px;
        }
        .legend-item span:first-child {
          font-size: 11px;
        }
        .swatch {
          width: 32px;
          height: 16px;
        }
        .muted {
          font-size: 10px;
          margin-top: 4px;
        }
        .footer {
          display: none;
        }
        /* Hide mobile elements that would require scrolling */
        #status + .box {
          /* Hide the large instruction box ("Click a line...") on mobile */
          display: none;
        }
        .legend-note {
          /* Hide the long legend explanation paragraph */
          display: none;
        }
        /* Allow detail table to show - panel will scroll if needed */
        #detail {
          margin-top: 6px;
        }
        /* When detail is visible, allow scrolling on mobile */
        #side.expanded.has-detail {
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          touch-action: pan-y;
        }
        table {
          font-size: 10px;
        }
        th, td {
          padding: 3px;
          font-size: 10px;
        }
      }

      @media (max-width: 480px) {
        :root {
          --tab-h: calc(70px + env(safe-area-inset-bottom));
        }
        #side {
          padding: calc(5px + env(safe-area-inset-top)) calc(6px + env(safe-area-inset-right)) 0 calc(6px + env(safe-area-inset-left));
          padding-bottom: var(--tab-h);
        }
        .row {
          margin-bottom: 5px;
          gap: 5px;
        }
        .row label {
          min-width: 65px;
          font-size: 12px;
        }
        select, button, input {
          padding: 5px 6px;
          font-size: 12px;
        }
        .box {
          padding: 5px 6px;
          margin-top: 5px;
          font-size: 11px;
        }
        .legend-item {
          padding: 3px 5px;
          font-size: 10px;
        }
        #status {
          font-size: 10px;
        }
      }

    </style>
  </head>
  <body>
    <div id="app">
      <div id="map"></div>
      <div class="mobile-link-notification" id="mobileLinkNotification">
        Reception table updated — view in panel below
      </div>
      <div id="side">
        <div class="side-inner">
        <div class="mobile-side-header">
          <div class="mobile-side-handle"></div>
          <button type="button" class="mobile-side-close" id="sidebarClose">back to map</button>
        </div>
        <div class="logo-wrap">
          <pre class="logo">  ░█▀▀░█▀▀░█▀▀░█▀▀░█▀█░█░█░░
  ░█░░░█▀▀░█▀▀░█▀▀░█▀█░▄▀▄░░
  ░▀▀▀░▀▀▀░▀▀▀░▀░░░▀░▀░▀░▀░░
░█▀▀░▀█▀░█▀█░▀█▀░▀█▀░█▀█░█▀█
░▀▀█░░█░░█▀█░░█░░░█░░█░█░█░█
░▀▀▀░░▀░░▀░▀░░▀░░▀▀▀░▀▀▀░▀░▀</pre>
        </div>
        <div class="alpha-banner">
          <span class="alpha-label">Alpha</span>
          Site in active development — features may change
        </div>
        <div class="row">
          <label for="range">Time Frame</label>
          <select id="range">
            <option value="24h">Last 24 hours</option>
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
          </select>
          <button id="refresh">Refresh</button>
        </div>
        <div class="row">
          <label for="band">Band</label>
          <select id="band">
            <option value="">All bands</option>
            <option value="40m">40m (7.040 MHz)</option>
            <option value="20m">20m (14.105 MHz)</option>
            <option value="10m">10m (28.120 MHz)</option>
            <option value="6m">6m (50.200 MHz)</option>
            <option value="2m">2m (144.800 MHz)</option>
            <option value="70cm">70cm (433.500 MHz)</option>
          </select>
        </div>
        <div class="muted" id="status">Connecting…</div>

        <div class="box">
          <div><strong>Click a line</strong> to see pages TX and RX status.</div>
          <div class="muted">Stations require Maidenhead (grid) to appear on the map.</div>
        </div>

        <div class="box">
          <div><strong>Legend</strong></div>
          <div class="legend">
            <div class="legend-item"><span>Transmitting station (TX)</span><span class="swatch sw-green"></span></div>
            <div class="legend-item"><span>Receiving OK (all pages)</span><span class="swatch sw-yellow"></span></div>
            <div class="legend-item"><span>Receiving partial (missing pages)</span><span class="swatch sw-blue"></span></div>
          </div>
          <div class="muted legend-note" style="margin-top:8px;">
            Partial stations render as a diagonal split (top-left = station color, bottom-right = blue).
            Links are yellow when complete and blue when incomplete.
          </div>
        </div>

        <div class="box" id="detail" style="display:none;">
          <div class="row">
            <strong id="linkTitle"></strong>
          </div>
          <div class="muted" id="linkMeta"></div>
          <div class="muted" id="linkDistance" style="margin-top:6px;"></div>
          <div style="margin-top:10px;" id="linkTableContainer">
            <table>
              <thead>
                <tr>
                  <th>Page</th>
                  <th class="cell-center">TX</th>
                  <th class="cell-center">RX</th>
                  <th>dB</th>
                  <th>Age</th>
                </tr>
              </thead>
              <tbody id="linkTable"></tbody>
            </table>
          </div>
        </div>

        <div class="footer">
          <div class="line"><a href="https://github.com/thaum-labs/ceefax_station" target="_blank" rel="noopener noreferrer">Download Ceefax Station</a></div>
          <div class="line"><a href="/about" style="text-decoration:underline;">About</a> · <a href="/changelog" style="text-decoration:underline;">Changelog</a> · <span id="versionDisplay"></span></div>
          <div class="line">Created by <strong>M7TJF</strong> · Ceefax Station © <span id="year"></span></div>
        </div>
        </div>
      </div>
      <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
        <span class="sidebar-toggle-text">filters &amp; settings</span>
      </button>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const map = L.map('map', { worldCopyJump: true }).setView([54.5, -2.5], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const rangeSel = document.getElementById('range');
      const bandSel = document.getElementById('band');
      const refreshBtn = document.getElementById('refresh');
      const statusEl = document.getElementById('status');
      const detailBox = document.getElementById('detail');
      const linkTitle = document.getElementById('linkTitle');
      const linkMeta = document.getElementById('linkMeta');
      const linkDistance = document.getElementById('linkDistance');
      const sidebarEl = document.getElementById('side');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarClose = document.getElementById('sidebarClose');

      // Mobile sidebar toggle
      if (sidebarToggle && sidebarEl) {
        const toggleSidebar = () => {
          sidebarEl.classList.toggle('expanded');
          // Prevent body scroll when sidebar is expanded, but sidebar itself can scroll
          if (sidebarEl.classList.contains('expanded')) {
            // Only prevent body scroll, sidebar will handle its own scrolling
            document.body.style.overflow = 'hidden';
          } else {
            document.body.style.overflow = '';
            // Remove has-detail class when closing
            sidebarEl.classList.remove('has-detail');
          }
          // Resize map after transition
          setTimeout(() => {
            map.invalidateSize();
          }, 300);
        };
        
        sidebarToggle.addEventListener('click', toggleSidebar);
        if (sidebarClose) {
          sidebarClose.addEventListener('click', () => {
            sidebarEl.classList.remove('expanded');
            sidebarEl.classList.remove('has-detail');
            document.body.style.overflow = '';
            setTimeout(() => {
              map.invalidateSize();
            }, 300);
          });
        }
        
        // Close sidebar when clicking outside on mobile
        if (window.innerWidth <= 768) {
          sidebarEl.addEventListener('click', (e) => {
            if (e.target === sidebarEl) {
              sidebarEl.classList.remove('expanded');
              sidebarEl.classList.remove('has-detail');
              document.body.style.overflow = '';
              setTimeout(() => {
                map.invalidateSize();
              }, 300);
            }
          });
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
          if (window.innerWidth > 768) {
            sidebarEl.classList.remove('expanded');
            sidebarEl.classList.remove('has-detail');
            document.body.style.overflow = '';
            map.invalidateSize();
          }
        });
      }

      let stationMarkers = new Map(); // callsign -> {layers:[]}
      let linkLayers = [];
      let currentRange = rangeSel.value;
      let currentBand = bandSel.value;

      // Palette (matches current design)
      const COLOR = {
        ok: '#ffd34d',     // yellow
        warn: '#4aa3ff',   // blue
        tx: '#2ecc71'      // green
      };

      // Animated "flow" links (GridTracker-ish direction indicator)
      let flowLinks = []; // { el, offset, speed }
      let flowRaf = null;

      function _getPathElement(polyline) {
        // Leaflet >=1.9 supports getElement(); fallback to internal _path.
        if (polyline && typeof polyline.getElement === 'function') return polyline.getElement();
        return polyline && polyline._path ? polyline._path : null;
      }

      function startFlowLoop() {
        if (flowRaf) return;
        const tick = () => {
          for (const f of flowLinks) {
            if (!f.el) continue;
            // Negative dashoffset makes the dash pattern move along the path direction (start -> end).
            f.offset = (f.offset - f.speed) % 1000;
            f.el.style.strokeDashoffset = String(f.offset);
          }
          flowRaf = requestAnimationFrame(tick);
        };
        flowRaf = requestAnimationFrame(tick);
      }

      function stopFlowLoopIfIdle() {
        if (flowLinks.length !== 0) return;
        if (flowRaf) {
          cancelAnimationFrame(flowRaf);
          flowRaf = null;
        }
      }

      function clearLinks() {
        for (const l of linkLayers) map.removeLayer(l);
        linkLayers = [];
        flowLinks = [];
        stopFlowLoopIfIdle();
      }

      function setTags(el, pages) {
        el.innerHTML = '';
        if (!pages || pages.length === 0) {
          el.innerHTML = '<span class="muted">None</span>';
          return;
        }
        for (const p of pages) {
          const s = document.createElement('span');
          s.className = 'tag';
          s.textContent = p;
          el.appendChild(s);
        }
      }

      async function fetchMap() {
        currentRange = rangeSel.value;
        currentBand = bandSel.value;
        statusEl.textContent = 'Loading…';
        let url = `/api/map?range=${encodeURIComponent(currentRange)}`;
        if (currentBand) {
          url += `&band=${encodeURIComponent(currentBand)}`;
        }
        const resp = await fetch(url);
        const data = await resp.json();
        renderMap(data);
        const bandText = currentBand ? `, Band=${currentBand}` : '';
        statusEl.textContent = `Updated. Range=${data.range}${bandText} (since ${data.since_utc})`;
      }

      function renderMap(data) {
        // Stations
        const seen = new Set();
        for (const s of data.stations) {
          // Require bbox (grid) to draw a rectangle.
          if (!s.bbox || !s.bbox.sw || !s.bbox.ne) continue;
          seen.add(s.callsign);
          if (!stationMarkers.has(s.callsign)) {
            const sw = [s.bbox.sw.lat, s.bbox.sw.lon];
            const ne = [s.bbox.ne.lat, s.bbox.ne.lon];

            const layers = [];
            const isTx = !!s.is_tx;
            const isNone = (s.status === 'none');
            const primary = isNone ? COLOR.warn : (isTx ? COLOR.tx : COLOR.ok); // blue if not receiving, else TX green / yellow
            const secondary = COLOR.warn; // blue for missing/links
            const outline = primary;

            if (s.status === 'partial') {
              // Two triangles: top-left yellow, bottom-right blue
              const nw = [ne[0], sw[1]];
              const se = [sw[0], ne[1]];

              // Less transparency (more opaque) than before.
              const tri1 = L.polygon([nw, ne, sw], { color: primary, weight: 1, fillColor: primary, fillOpacity: 0.55 });
              const tri2 = L.polygon([sw, ne, se], { color: secondary, weight: 1, fillColor: secondary, fillOpacity: 0.40 });
              const box = L.rectangle([sw, ne], { color: outline, weight: 2, fillOpacity: 0 });
              const diag = L.polyline([nw, se], { color: outline, weight: 1, opacity: 0.95 });
              layers.push(tri1, tri2, box, diag);
            } else {
              // Less transparency (more opaque) than before.
              const rect = L.rectangle([sw, ne], { color: outline, weight: 2, fillColor: primary, fillOpacity: 0.40 });
              layers.push(rect);
            }

            for (const l of layers) l.addTo(map);

            const role = isTx ? 'TX' : ((s.is_rx) ? 'RX' : 'RX (none)');
            const gridDisplay = s.grid ? ` (${s.grid})` : '';
            const popupHtml = `<b>${s.callsign}${gridDisplay}</b><br/>Grid: ${s.grid || '-'}<br/>Role: ${role}<br/>Status: ${s.status || '-'}<br/><span class="muted">Last seen: ${s.last_seen_utc || '-'}</span>`;
            for (const l of layers) l.bindPopup(popupHtml);
            for (const l of layers) l.bindTooltip(`${s.callsign}${gridDisplay}`, { sticky: true });

            stationMarkers.set(s.callsign, { layers });
          }
        }
        for (const [cs, obj] of stationMarkers.entries()) {
          if (!seen.has(cs)) {
            for (const l of (obj.layers || [])) map.removeLayer(l);
            stationMarkers.delete(cs);
          }
        }

        // Links
        clearLinks();
        const byCall = new Map(data.stations.map(s => [s.callsign, s]));
        for (const l of data.links) {
          const tx = byCall.get(l.tx_callsign);
          const rx = byCall.get(l.rx_callsign);
          if (!tx || !rx || !tx.bbox || !rx.bbox) continue;
          const txSw = [tx.bbox.sw.lat, tx.bbox.sw.lon];
          const txNe = [tx.bbox.ne.lat, tx.bbox.ne.lon];
          const rxSw = [rx.bbox.sw.lat, rx.bbox.sw.lon];
          const rxNe = [rx.bbox.ne.lat, rx.bbox.ne.lon];
          const txC = [(txSw[0] + txNe[0]) / 2, (txSw[1] + txNe[1]) / 2];
          const rxC = [(rxSw[0] + rxNe[0]) / 2, (rxSw[1] + rxNe[1]) / 2];

          const weight = Math.min(8, 1 + Math.log10(1 + (l.rx_pages_ok_unique || 0)) * 2);
          // Links: yellow if complete, blue if incomplete.
          const lineColor = (l.complete ? COLOR.ok : COLOR.warn);
          // Wide invisible hit-area line for easier clicking/hovering.
          const hit = L.polyline([txC, rxC], {
            color: '#000',
            opacity: 0.0,
            weight: Math.max(18, weight + 14),
            interactive: true
          });

          const poly = L.polyline([txC, rxC], {
            color: lineColor,
            weight,
            opacity: 0.85,
            dashArray: '10 14' // animated later via dashoffset
          });

          const onClick = () => showLinkDetail(l.tx_callsign, l.rx_callsign);
          hit.on('click', onClick);
          poly.on('click', onClick);

          // Desktop: show hover tooltips for link lines. Mobile: suppress to avoid popups.
          if (window.innerWidth > 768) {
            const total = (l.tx_pages_unique || 0);
            const txGrid = tx && tx.grid ? ` (${tx.grid})` : '';
            const rxGrid = rx && rx.grid ? ` (${rx.grid})` : '';
            const tip = `${l.tx_callsign}${txGrid} → ${l.rx_callsign}${rxGrid} (${l.rx_pages_ok_unique || 0}/${total} pages ok)`;
            hit.bindTooltip(tip, { sticky: true });
            poly.bindTooltip(tip, { sticky: true });
          }

          hit.addTo(map);
          poly.addTo(map);
          linkLayers.push(hit, poly);

          // Enable animated flow (TX -> RX) once Leaflet has created the SVG path.
          setTimeout(() => {
            const el = _getPathElement(poly);
            if (!el) return;
            el.style.strokeLinecap = 'round';
            // Speed scales slightly with link weight so "stronger" links look more lively.
            // Slow down animation by 50% (compared to initial implementation).
            const spd = Math.max(0.3, Math.min(1.2, (weight / 3) * 0.5));
            flowLinks.push({ el, offset: 0, speed: spd });
            startFlowLoop();
          }, 0);
        }
      }

      async function showLinkDetail(tx, rx) {
        const resp = await fetch(`/api/link?tx=${encodeURIComponent(tx)}&rx=${encodeURIComponent(rx)}&range=${encodeURIComponent(currentRange)}`);
        const d = await resp.json();
        detailBox.style.display = '';
        // Enable scrolling on mobile when detail is shown
        if (window.innerWidth <= 768 && sidebarEl && sidebarEl.classList.contains('expanded')) {
          sidebarEl.classList.add('has-detail');
        }
        // Show mobile notification if on mobile (include TX -> RX only)
        if (window.innerWidth <= 768) {
          const notification = document.getElementById('mobileLinkNotification');
          if (notification) {
            notification.textContent = `${tx} → ${rx} reception table updated`;
            notification.classList.add('show');
            // Auto-hide after 4 seconds
            setTimeout(() => {
              notification.classList.remove('show');
            }, 4000);
          }
        }
        const txGrid = d.tx_grid ? ` (${d.tx_grid})` : '';
        const rxGrid = d.rx_grid ? ` (${d.rx_grid})` : '';
        linkTitle.textContent = `${d.tx_callsign}${txGrid} → ${d.rx_callsign}${rxGrid}`;
        linkMeta.textContent = `Range=${d.range} (since ${d.since_utc})`;

        // Distance
        if (d.distance_km != null && d.distance_mi != null) {
          const km = Number(d.distance_km);
          const mi = Number(d.distance_mi);
          linkDistance.textContent = `Distance: ${km.toFixed(1)} km / ${mi.toFixed(1)} mi`;
        } else {
          linkDistance.textContent = '';
        }

        const rows = Array.isArray(d.rows) ? d.rows : [];
        const container = document.getElementById('linkTableContainer');
        container.innerHTML = '';
        
        if (rows.length === 0) {
          const table = document.createElement('table');
          const tbody = document.createElement('tbody');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="5" class="muted">No pages in this window.</td>`;
          tbody.appendChild(tr);
          table.appendChild(tbody);
          container.appendChild(table);
          return;
        }

        function fmtAge(sec) {
          const s = Math.max(0, Math.floor(sec || 0));
          if (s < 60) return `${s}s`;
          const m = Math.floor(s / 60);
          if (m < 60) return `${m}m`;
          const h = Math.floor(m / 60);
          if (h < 48) return `${h}h`;
          const d = Math.floor(h / 24);
          return `${d}d`;
        }

        function box(ok) {
          if (ok) return `<span class="boxmark box-ok">✓</span>`;
          return `<span class="boxmark box-bad">✗</span>`;
        }

        // Group rows by frequency
        const rowsByFreq = new Map();
        for (const r of rows) {
          const freq = r.frequency || 'Unknown';
          if (!rowsByFreq.has(freq)) {
            rowsByFreq.set(freq, []);
          }
          rowsByFreq.get(freq).push(r);
        }

        // Create a table for each frequency
        const frequencies = Array.from(rowsByFreq.keys()).sort();
        for (let i = 0; i < frequencies.length; i++) {
          const freq = frequencies[i];
          const freqRows = rowsByFreq.get(freq);
          
          // Frequency header
          const freqHeader = document.createElement('div');
          freqHeader.style.marginTop = i > 0 ? '20px' : '0';
          freqHeader.style.marginBottom = '8px';
          freqHeader.style.fontWeight = '600';
          freqHeader.style.color = '#ffd34d';
          freqHeader.style.fontSize = '14px';
          freqHeader.textContent = freq;
          container.appendChild(freqHeader);

          // Table for this frequency
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          headerRow.innerHTML = `
            <th>Page</th>
            <th class="cell-center">TX</th>
            <th class="cell-center">RX</th>
            <th>dB</th>
            <th>Age</th>
          `;
          thead.appendChild(headerRow);
          table.appendChild(thead);

          // Table body
          const tbody = document.createElement('tbody');
          for (const r of freqRows) {
            const page = r.page_id || '-';
            const txOk = !!r.tx;
            const rxOk = !!r.rx_ok;
            const db = (r.rx_db == null ? '-' : `${Number(r.rx_db).toFixed(1)}`);
            const age = fmtAge(r.age_s);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${page}</td>
              <td class="cell-center">${box(txOk)}</td>
              <td class="cell-center">${box(rxOk)}</td>
              <td>${db}</td>
              <td>${age}</td>
            `;
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          container.appendChild(table);
        }
      }

      refreshBtn.addEventListener('click', fetchMap);
      rangeSel.addEventListener('change', fetchMap);
      bandSel.addEventListener('change', fetchMap);

      // Live updates via WebSocket (best-effort).
      function connectWS() {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${proto}://${location.host}/ws`);
        ws.onopen = () => { statusEl.textContent = 'Live connected'; };
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.type === 'ingested') fetchMap();
          } catch {}
        };
        ws.onclose = () => {
          statusEl.textContent = 'Live disconnected; retrying…';
          setTimeout(connectWS, 1500);
        };
      }

      fetchMap();
      connectWS();

      // Footer year
      document.getElementById('year').textContent = String(new Date().getFullYear());

      // Load version on page load
      const versionDisplay = document.getElementById('versionDisplay');
      (async () => {
        try {
          const res = await fetch('/api/version');
          const data = await res.json();
          if (data.version && data.version !== 'unknown') {
            const version = data.version;
            const stage = version.includes('-alpha') ? 'alpha' : 
                         version.includes('-beta') ? 'beta' : 'release';
            const versionText = `v${version}${stage !== 'release' ? ` (${stage})` : ''}`;
            versionDisplay.textContent = versionText;
          }
        } catch (err) {
          console.error('Failed to load version:', err);
        }
      })();
    </script>
  </body>
</html>


